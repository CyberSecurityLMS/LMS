# Миграции БД (`golang-migrate`)

## Что такое миграции?

**Миграции** — это SQL-файлы для управления изменениями в структуре базы данных:

- `<номер>_<описание>.up.sql` — действия для обновления схемы (например, создать таблицы/колонки)
- `<номер>_<описание>.down.sql` — откат изменений (например, удалить таблицу/колонку)

Мы используем [golang-migrate/migrate](https://github.com/golang-migrate/migrate), чтобы схема БД оставалась одинаковой у всех разработчиков, на тесте и в продакшене.

---

## Как добавить новую миграцию

1. **Создай новые файлы в папке [`migrations/`](./) рядом с проектом**
    - Используй последовательную нумерацию!
    - Пример:
      ```
      003_add_otp_to_users.up.sql
      003_add_otp_to_users.down.sql
      ```

2. **В `*.up.sql`** прописываются изменения:
   ```sql
   ALTER TABLE users ADD COLUMN otp_code VARCHAR(16), ADD COLUMN otp_expires_at DATETIME;
   ```

3. **В `*.down.sql`** прописывается откат изменений:
   ```sql
   ALTER TABLE users DROP COLUMN otp_code, DROP COLUMN otp_expires_at;
   ```

## Когда писать новую миграцию?
- Добавил(а) новую таблицу, колонку, индекс, etc.
- Меняешь свойства или удаляешь что-то устаревшее.
- Хочешь засеять БД начальными данными (seed).

## Какой рабочий процесс при изменении схемы БД?
- Сначала напиши / скопируй новую миграцию в migrations/
- Проверь локально, что она применяется без ошибок
- Закоммить её в git и создай Pull Request
- После деплоя убедись, что на dev- и prod-базе изменения накатились и всё работает

## ⚠️ Важно
- ВСЕ изменения БД — только через миграции!
- Не делай DDL (CREATE/DROP/ALTER) прямо в коде микросервиса!
- Пиши BOTH up и down миграции (если откат технически возможен)
- Не изменяй уже применённые миграции — только добавляй новые

## Пример именования
- 001_create_users_table.up.sql / 001_create_users_table.down.sql
- 002_add_last_login_to_users.up.sql / 002_add_last_login_to_users.down.sql
- 003_add_otp_to_users.up.sql / 003_add_otp_to_users.down.sql